# AN-Net 复现指南（CipherSpectrum 版，Windows + Conda）

本文档只针对 **CipherSpectrum** 数据集，说明如何从 pcap 到训练、测试完整跑通 AN-Net。

- 环境准备
- CipherSpectrum 数据放置方式
- 从 pcap 到训练特征
- 训练 / 测试命令
- 常见问题

> 默认在项目根目录 `AN-Net/` 下执行所有命令。

---

## 1. 环境配置

### 1.1 创建 Conda 环境

```bash
conda create -n ANNet python=3.8 -y
conda activate ANNet
```

### 1.2 安装 PyTorch 与依赖

```bash
pip install torch==1.13.1+cu116 torchvision==0.14.1+cu116 torchaudio==0.13.1 \
  --extra-index-url https://download.pytorch.org/whl/cu116

pip install scapy
pip install tqdm
pip install scipy==1.8.1
pip install scikit-learn
pip install matplotlib
pip install timm==0.4.12
```

自检：

```bash
python -c "import torch, timm, sklearn, tqdm, matplotlib, scipy; print('ok')"
```

输出 `ok` 即环境正常。

---

## 2. 代码与目录结构

- `main.py`：训练 / 测试入口。
- `model.py`：模型与 `TrafficDataset` 定义。
- `data_extract.py`：从 CipherSpectrum pcap 提取原始序列特征到 `RawData/CipherSpectrum/...`。
- `data_process.py`：把 `RawData*` 转换为 `data_*` 训练特征。

训练结果：

- 日志：`result/*.txt`
- 曲线：`result/*.png`

---

## 3. CipherSpectrum 数据准备

### 3.1 目录结构

假设 CipherSpectrum 已按“域名 → 多会话 pcap”组织，每个 pcap = 单会话。

在 `AN-Net/` 下创建：

```text
AN-Net/
  traffic_data/
    CipherSpectrum/
      domain1/
        session1.pcap
        session2.pcap
      domain2/
        session3.pcap
        ...
```

要求：

- 扩展名 `.pcap`；
- 每个 `session*.pcap` 尽量是一条 TCP 流。

当前代码已经改为：**只读取 `traffic_data/CipherSpectrum/*/*.pcap`，不会再用 SJTU 等原始数据集。**

---

## 4. 从 pcap 到训练特征

整体流程：

1. `data_extract.py`：pcap → `RawData/CipherSpectrum/...` 原始特征；
2. `data_process.py`：RawData → `data_0.0/CipherSpectrum/...` 训练特征。

### 4.1 Step 1：提取 RawData

在项目根目录：

```bash
python data_extract.py
```

会遍历：

```text
traffic_data/CipherSpectrum/*/*.pcap
```

生成：

```text
RawData/CipherSpectrum/<domain>/<session>_L.npy  # 载荷长度序列（Packet Size）
RawData/CipherSpectrum/<domain>/<session>_T.npy  # IAT 时间间隔
RawData/CipherSpectrum/<domain>/<session>_P.npy  # TCP 报文字节片段（hex）
RawData/CipherSpectrum/<domain>/<session>_O.npy  # IP TTL
RawData/CipherSpectrum/<domain>/<session>_F.npy  # IPFlag
RawData/CipherSpectrum/<domain>/<session>_C.npy  # TCPFlag
```

### 4.2 Step 2：生成训练特征

常用两种方式：

- 只要主方法 ShortTerm：

```bash
python data_process.py --methods ShortTerm
```

- 生成全部方法特征：

```bash
python data_process.py --methods ALL
```

会在 `data_0.0` 下生成：

```text
data_0.0/CipherSpectrum/<domain>/ShortTerm/<session>.npy
data_0.0/CipherSpectrum/<domain>/Flowlens/<session>.npy
data_0.0/CipherSpectrum/<domain>/Fs-net/<session>.npy
data_0.0/CipherSpectrum/<domain>/Whisper/<session>.npy
data_0.0/CipherSpectrum/<domain>/Characterize/<session>.npy
data_0.0/CipherSpectrum/<domain>/Robust/<session>.npy
data_0.0/CipherSpectrum/<domain>/AttnLSTM/<session>.npy
```

如未运行 `add_noise.py`，只会用到 `data_0.0`（无噪声）。

---

## 5. 训练与测试

### 5.1 主方法 ShortTerm

在 `AN-Net/` 根目录执行（已激活 `ANNet` 环境）：

```bash
python -u main.py --dataset 0 --noise 0.0 --method ShortTerm
```

说明：

- `--method ShortTerm`：使用多模态主模型；
- `--noise 0.0`：对应 `data_0.0`；
- `--dataset 0`：当前代码中数据集编号为 0，可按需要在 `model.py` 中重新解释为 CipherSpectrum。

其他方法示例：

```bash
python -u main.py --dataset 0 --noise 0.0 --method Flowlens
python -u main.py --dataset 0 --noise 0.0 --method Whisper
python -u main.py --dataset 0 --noise 0.0 --method Robust
...
```

日志与曲线默认写入 `result/` 目录。

---

## 6. 常见问题

- **`FileNotFoundError` / 找不到数据**：
  - 确认 `traffic_data/CipherSpectrum/<domain>/*.pcap` 路径正确；
  - 确认已运行 `data_extract.py` 和 `data_process.py`；
  - 检查 `RawData/CipherSpectrum/...` 与 `data_0.0/CipherSpectrum/...` 是否存在。

- **张量维度错误**：
  - 通常是 `data_process.py` 没跑完整或 `--method` 与现有特征不匹配（例如只生成 ShortTerm 却用 Whisper）。

- **CUDA / 显存问题**：
  - `python -c "import torch; print(torch.cuda.is_available())"` 检查 GPU；
  - 需要时在 `main.py` 减小 `batch_size` 或 `--data_size`。

---

## 7. 建议实验流程

1. 配好环境，按 3.1 放置 CipherSpectrum；
2. 跑 `python data_extract.py`，确认生成 `RawData/CipherSpectrum/...`；
3. 跑 `python data_process.py --methods ShortTerm`，生成 `data_0.0/CipherSpectrum/...`；
4. 跑 `python -u main.py --dataset 0 --noise 0.0 --method ShortTerm`，验证 pipeline；
5. 需要时再扩展到 Flowlens / Whisper / Robust 等其他方法，或加入噪声实验。

---
  - TLS 注入噪声：`"0.5_TLS"`, `"0.75_TLS"`
  - 模拟噪声：`"0.5_SIM"`, `"0.75_SIM"`
- 其他关键参数（主要针对 `ShortTerm`）：
  - `--num_layer`：FC 层数（默认 2）
  - `--with_relu`：是否使用 ReLU（1/0）
  - `--with_ht`：高温度缩放相关（1/0）
  - `--with_re`：是否启用 RE 模块（1/0）
  - `--temp`：温度参数
  - `--data_size`：训练数据采样比例（0–1 之间）

日志与结果保存：

- 若 `method == "ShortTerm"`：

  - 日志：`result/Dataset_{dataset}_Method_{method}_Noise_{noise}_NumLayer_{num_layer}_ReLU_{with_relu}_HT_{with_ht}_RE_{with_re}_DataSize_{data_size}_Temp_{temp}.txt`
  - 曲线：同名 `.png`

- 其他方法：

  - 日志：`result/Dataset_{dataset}_Method_{method}_Noise_{noise}.txt`

### 4.2 基本复现命令示例

以下命令均假设你已在项目根目录，并激活 Conda 环境 `ANNet`。

#### 4.2.1 无噪声（noise = 0.0），SJTUAN21（dataset = 0）

```bash
# ShortTerm（核心方法）
python -u main.py --dataset 0 --noise 0.0 --method ShortTerm

# 对比方法：Whisper / Characterize / Robust / Flowlens / AttnLSTM / Fs-net / ETBert
python -u main.py --dataset 0 --noise 0.0 --method Whisper
python -u main.py --dataset 0 --noise 0.0 --method Characterize
python -u main.py --dataset 0 --noise 0.0 --method Robust
python -u main.py --dataset 0 --noise 0.0 --method Flowlens
python -u main.py --dataset 0 --noise 0.0 --method AttnLSTM
python -u main.py --dataset 0 --noise 0.0 --method Fs-net
python -u main.py --dataset 0 --noise 0.0 --method ETBert
```

#### 4.2.2 TLS 噪声（noise = 0.5_TLS / 0.75_TLS）

```bash
# 0.5 TLS 噪声
python -u main.py --dataset 0 --noise 0.5_TLS --method ShortTerm
python -u main.py --dataset 0 --noise 0.5_TLS --method Whisper
python -u main.py --dataset 0 --noise 0.5_TLS --method Characterize
python -u main.py --dataset 0 --noise 0.5_TLS --method Robust
python -u main.py --dataset 0 --noise 0.5_TLS --method Flowlens
python -u main.py --dataset 0 --noise 0.5_TLS --method AttnLSTM
python -u main.py --dataset 0 --noise 0.5_TLS --method Fs-net
python -u main.py --dataset 0 --noise 0.5_TLS --method ETBert

# 0.75 TLS 噪声
python -u main.py --dataset 0 --noise 0.75_TLS --method ShortTerm
python -u main.py --dataset 0 --noise 0.75_TLS --method Whisper
python -u main.py --dataset 0 --noise 0.75_TLS --method Characterize
python -u main.py --dataset 0 --noise 0.75_TLS --method Robust
python -u main.py --dataset 0 --noise 0.75_TLS --method Flowlens
python -u main.py --dataset 0 --noise 0.75_TLS --method AttnLSTM
python -u main.py --dataset 0 --noise 0.75_TLS --method Fs-net
python -u main.py --dataset 0 --noise 0.75_TLS --method ETBert
```

#### 4.2.3 模拟噪声（noise = 0.5_SIM / 0.75_SIM）

```bash
# 0.5 模拟噪声
python -u main.py --dataset 0 --noise 0.5_SIM --method ShortTerm
python -u main.py --dataset 0 --noise 0.5_SIM --method Whisper
python -u main.py --dataset 0 --noise 0.5_SIM --method Characterize
python -u main.py --dataset 0 --noise 0.5_SIM --method Robust
python -u main.py --dataset 0 --noise 0.5_SIM --method Flowlens
python -u main.py --dataset 0 --noise 0.5_SIM --method AttnLSTM
python -u main.py --dataset 0 --noise 0.5_SIM --method Fs-net
python -u main.py --dataset 0 --noise 0.5_SIM --method ETBert

# 0.75 模拟噪声
python -u main.py --dataset 0 --noise 0.75_SIM --method ShortTerm
python -u main.py --dataset 0 --noise 0.75_SIM --method Whisper
python -u main.py --dataset 0 --noise 0.75_SIM --method Characterize
python -u main.py --dataset 0 --noise 0.75_SIM --method Robust
python -u main.py --dataset 0 --noise 0.75_SIM --method Flowlens
python -u main.py --dataset 0 --noise 0.75_SIM --method AttnLSTM
python -u main.py --dataset 0 --noise 0.75_SIM --method Fs-net
python -u main.py --dataset 0 --noise 0.75_SIM --method ETBert
```

> 提示：若只做快速 sanity check，可先只跑 `ShortTerm` + 一种噪声配置，确认 pipeline 正常，再扩展到全部组合。

---
